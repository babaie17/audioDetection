<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Mic → Cloud ASR (Top 5)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#0b1020; --card:#141a2e; --accent:#7aa2ff; --text:#e8ecff; --muted:#a6b0d6; }
    html,body { height:100%; margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, "Helvetica Neue", sans-serif; background:var(--bg); color:var(--text); }
    .wrap { max-width: 760px; margin: 40px auto; padding: 24px; background:var(--card); border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,.35); }
    h1 { margin:0 0 16px; font-size: 22px; }
    .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    select, button { background:#1b2340; color:var(--text); border:1px solid #2a3766; border-radius: 10px; padding:10px 12px; font-size:15px; }
    select:focus, button:focus { outline: 2px solid var(--accent); outline-offset: 2px; }
    button.mic { font-weight:600; border-radius: 999px; padding:14px 18px; display:inline-flex; align-items:center; gap:10px; }
    button.mic.recording { background: #b42334; border-color: #ff8a9b; }
    .status { margin-top: 14px; color: var(--muted); min-height: 1.4em; }
    .results { margin-top: 16px; background:#0f1630; border:1px solid #29376b; border-radius: 12px; padding: 12px; }
    .results h3 { margin: 0 0 8px; font-size:15px; color: var(--muted); }
    .list { display:flex; flex-direction:column; gap:8px; }
    .item { background:#121a38; border:1px solid #2a3766; border-radius: 10px; padding:10px 12px; }
    .provider { margin-left:auto; font-size:12px; color:var(--muted); }
    .controls { display:flex; gap:10px; align-items:center; }
    .pill { background:#0c1330; border:1px solid #26407a; padding:7px 10px; border-radius:999px; color:var(--muted); font-size:12px; }
    .note { margin-top:10px; color:#aab4e4; font-size:13px; }
    .error { color:#ff9aa4; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Cloud Speech Test (Top-5)</h1>

    <div class="row">
      <label for="lang">Language:</label>
      <select id="lang">
        <!-- You can add more BCP-47 codes here -->
        <option value="en-US" selected>English (United States)</option>
        <option value="zh-CN">中文（普通话，中国）</option>
        <option value="zh-TW">中文（國語，台灣）</option>
        <option value="ja-JP">日本語</option>
        <option value="ko-KR">한국어</option>
        <option value="es-ES">Español (España)</option>
      </select>

      <div class="controls">
        <span class="pill" title="Select which cloud to use">
          Provider:
          <select id="provider" style="background:transparent;border:none;color:var(--text);">
            <option value="azure" selected>Azure (Top-5)</option>
            <option value="openai">OpenAI (1-best)</option>
          </select>
        </span>
      </div>
    </div>

    <div class="status" id="status">Idle.</div>

    <div class="results" id="results" hidden>
      <h3>Most probable results</h3>
      <div class="list" id="list"></div>
    </div>

    <div style="margin-top:16px;">
      <button id="micBtn" class="mic" type="button" aria-pressed="false">
        🎙️ <span id="micLabel">Start Recording</span>
      </button>
      <span class="provider" id="provInfo"></span>
    </div>

    <div class="note">
      Tip: click once to start, again to stop. Short utterances (&lt;10s) work best.
    </div>
  </div>

  <script>
    const langSel = document.getElementById('lang');
    const providerSel = document.getElementById('provider');
    const statusEl = document.getElementById('status');
    const micBtn = document.getElementById('micBtn');
    const micLabel = document.getElementById('micLabel');
    const resultsBox = document.getElementById('results');
    const listEl = document.getElementById('list');
    const provInfo = document.getElementById('provInfo');

    let mediaRecorder = null;
    let chunks = [];
    let recording = false;

    function setStatus(msg, isError=false) {
      statusEl.textContent = msg;
      statusEl.className = 'status' + (isError ? ' error' : '');
    }

    function setRecording(on) {
      recording = on;
      micBtn.classList.toggle('recording', on);
      micBtn.setAttribute('aria-pressed', on ? 'true' : 'false');
      micLabel.textContent = on ? 'Stop Recording' : 'Start Recording';
      provInfo.textContent = `Using: ${providerSel.value.toUpperCase()}`;
    }

    async function startRecording() {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      chunks = [];
    
      // Prefer OGG/Opus (Azure-friendly); fallback to WebM/Opus
      let mime = '';
      if (MediaRecorder.isTypeSupported('audio/ogg;codecs=opus')) {
        mime = 'audio/ogg;codecs=opus';
      } else if (MediaRecorder.isTypeSupported('audio/webm;codecs=opus')) {
        mime = 'audio/webm;codecs=opus';
      } else {
        // last resort: let the browser pick a default
        mime = '';
      }
    
      mediaRecorder = new MediaRecorder(stream, mime ? { mimeType: mime } : undefined);
      chunks = [];
      mediaRecorder.ondataavailable = e => { if (e.data && e.data.size) chunks.push(e.data); };
      mediaRecorder.onstart = () => setStatus('Listening…');
      mediaRecorder.start();
    }

    function stopRecording() {
      return new Promise(resolve => {
        if (!mediaRecorder) return resolve(null);
        mediaRecorder.onstop = () => {
          const type = chunks[0]?.type || 'application/octet-stream';
          const blob = new Blob(chunks, { type });
          resolve(blob);
        };
        mediaRecorder.stop();
      });
    }

    function renderCandidates(arr) {
      console.log('[ASR candidates]', arr);
      const clean = (arr || []).map(s => (s || '').trim()).filter(s => s.length > 0).slice(0, 5);
      listEl.innerHTML = '';
      if (clean.length === 0) {
        resultsBox.hidden = false;
        const div = document.createElement('div');
        div.className = 'item';
        div.textContent = 'No speech recognized. Try a slightly longer/clearer utterance.';
        listEl.appendChild(div);
        return;
      }
      clean.forEach((t, i) => {
        const div = document.createElement('div');
        div.className = 'item';
        div.textContent = `${i+1}. ${t}`;
        listEl.appendChild(div);
      });
      resultsBox.hidden = false;
    }

    async function sendToServer(audioBlob) {
      const form = new FormData();
      form.append('audio', audioBlob, 'clip.webm');
      form.append('language', langSel.value);
      form.append('provider', providerSel.value);
      // form.append('debug','1'); // uncomment if you want raw upstream echoed back
    
      const r = await fetch('/api/transcribe', { method: 'POST', body: form });
    
      const ct = r.headers.get('content-type') || '';
      if (ct.includes('application/json')) {
        const data = await r.json();
        if (!r.ok) {
          const msg = typeof data.error === 'string' ? data.error : JSON.stringify(data.error || data);
          throw new Error(msg);
        }
        return data;
      } else {
        const text = await r.text();
        throw new Error(text || `HTTP ${r.status}`);
      }
    }

    micBtn.addEventListener('click', async () => {
      try {
        if (!recording) {
          await startRecording();
          setRecording(true);
        } else {
          setStatus('Processing…');
          const blob = await stopRecording();
          setRecording(false);
          if (!blob) { setStatus('No audio captured.', true); return; }
          const { provider, candidates } = await sendToServer(blob);
          renderCandidates(candidates);
          setStatus(`Done. Received ${candidates.length} result(s) from ${provider.toUpperCase()}.`);
        }
      } catch (err) {
        console.error(err);
        setRecording(false);
        setStatus(err.message || 'Error', true);
      }
    });
  </script>
</body>
</html>
